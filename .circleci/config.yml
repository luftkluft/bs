version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
       - image: circleci/ruby:2.5.3-node-browsers
         environment:
           - RAILS_ENV=test
           - DATABASE_URL=postgres://username@localhost:5432/bookstore_test
       - image: circleci/postgres:11
         environment:
           - POSTGRES_USER=username
           - POSTGRES_DB=bookstore_test

    working_directory: ~/repo

    steps:
          - checkout

          # Download and cache dependencies
          - restore_cache:
              keys:
              - v1-dependencies-{{ checksum "Gemfile.lock" }}
              # fallback to using the latest cache if no exact match is found
              - v1-dependencies-
          - run:
              name: Install latest version of Bundler
              command: gem install bundler
          - restore_cache:
              key: Gemfile-{{ checksum "Gemfile.lock" }}
          - run:
              name: Install Ruby Dependencies
              command: bundle install
          - run: bundle show rails
          - save_cache:
              key: Gemfile-{{ checksum "Gemfile.lock" }}
              paths:
                - /usr/local/bundle/gems/
          - run:
                name: Wait for db
                command: |
                  dockerize -wait tcp://localhost:5432 -timeout 1m

            # Database setup
            - run:
              name: Set up DB
              command: |
                bundle install
                bundle exec rake db:create db:schema:load --trace
                bundle exec rake db:migrate
            - run:
                name: Run Tests
                command: bundle exec rspec .