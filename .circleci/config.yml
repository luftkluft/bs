version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
       - image: circleci/ruby:2.5.3-node-browsers
         environment:
           - RAILS_ENV=test
           - DATABASE_URL=postgres://username@localhost:5432/bookstore_test
       - image: circleci/postgres:11
         environment:
           - POSTGRES_USER=username
           - POSTGRES_DB=bookstore_test

    working_directory: ~/repo

    steps:
      - checkout

      # omitted steps ...

      - run:
          name: Wait for db
          command: |
            dockerize -wait tcp://localhost:5432 -timeout 1m

      # Database setup
      - run:
          name: Set up DB
          command: |
            bundle install
            bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java
            bundle exec rake db:create db:schema:load --trace
            bundle exec rake db:migrate